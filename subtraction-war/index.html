<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Game state
        let players = [];
        let currentPlayerIndex = 0;
        let gameActive = true;
        let roundActive = false;
        let deck = [];
        let playerDecks = [];
        let playerHands = [];
        let selectedCard = null;
        let playerEquations = [];
        let battleCompleted = false;
        
        // DOM elements
        const playersContainer = document.getElementById('playersContainer');
        const cardsContainer = document.getElementById('cardsContainer');
        const playerTurn = document.getElementById('playerTurn');
        const deckInfo = document.getElementById('deckInfo');
        const cardSelectionInfo = document.getElementById('cardSelectionInfo');
        const equationBuilder = document.getElementById('equationBuilder');
        const player1MinuendSlots = document.getElementById('player1MinuendSlots');
        const player1SubtrahendSlots = document.getElementById('player1SubtrahendSlots');
        const player1Result = document.getElementById('player1Result');
        const player1Difference = document.getElementById('player1Difference');
        const player2MinuendSlots = document.getElementById('player2MinuendSlots');
        const player2SubtrahendSlots = document.getElementById('player2SubtrahendSlots');
        const player2Result = document.getElementById('player2Result');
        const player2Difference = document.getElementById('player2Difference');
        const battleResult = document.getElementById('battleResult');
        const dealBtn = document.getElementById('dealBtn');
        const battleBtn = document.getElementById('battleBtn');
        const clearEquationBtn = document.getElementById('clearEquationBtn');
        const nextRoundBtn = document.getElementById('nextRoundBtn');
        const resetGameBtn = document.getElementById('resetGameBtn');
        const gameLog = document.getElementById('gameLog');
        const winMessage = document.getElementById('winMessage');
        const playerCountSelect = document.getElementById('playerCount');
        const digitCountSelect = document.getElementById('digitCount');
        const cardsPerPlayerSelect = document.getElementById('cardsPerPlayer');
        const faceCardsSelect = document.getElementById('faceCards');
        const aceValueSelect = document.getElementById('aceValue');
        const applySettingsBtn = document.getElementById('applySettings');
        const themeToggle = document.getElementById('themeToggle');
        
        // Theme toggle functionality
        let isLightMode = false;
        themeToggle.addEventListener('click', function() {
            isLightMode = !isLightMode;
            document.body.classList.toggle('light-mode', isLightMode);
            themeToggle.innerHTML = isLightMode ? 
                '<span>‚òÄÔ∏è Light Mode</span>' : 
                '<span>üåô Dark Mode</span>';
        });
        
        // Initialize the game
        function initializeGame() {
            const playerCount = parseInt(playerCountSelect.value);
            const digitCount = parseInt(digitCountSelect.value);
            const cardsPerPlayer = parseInt(cardsPerPlayerSelect.value);
            
            // Reset game state
            players = [];
            currentPlayerIndex = 0;
            gameActive = true;
            roundActive = false;
            playerDecks = [];
            playerHands = [];
            selectedCard = null;
            playerEquations = [];
            battleCompleted = false;
            
            // Clear containers
            playersContainer.innerHTML = '';
            cardsContainer.innerHTML = '';
            battleResult.style.display = 'none';
            winMessage.style.display = 'none';
            nextRoundBtn.style.display = 'none';
            clearAllEquations();
            
            // Create players
            for (let i = 0; i < playerCount; i++) {
                players.push({
                    id: i + 1,
                    name: `Player ${i + 1}`,
                    cards: 0,
                    wins: 0,
                    hasWon: false,
                    equationComplete: false
                });
                
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                playerCard.id = `playerCard${i + 1}`;
                
                const playerName = document.createElement('div');
                playerName.className = 'player-name';
                playerName.textContent = `Player ${i + 1}`;
                
                const playerScore = document.createElement('div');
                playerScore.className = 'player-score';
                playerScore.id = `playerScore${i + 1}`;
                playerScore.textContent = '0 Cards';
                
                const playerCardsCount = document.createElement('div');
                playerCardsCount.className = 'player-cards-count';
                playerCardsCount.id = `playerCardsCount${i + 1}`;
                playerCardsCount.textContent = 'Wins: 0';
                
                // Add player switch button
                const switchButton = document.createElement('button');
                switchButton.className = 'secondary-btn';
                switchButton.textContent = 'Build Equation';
                switchButton.style.marginTop = '10px';
                switchButton.style.fontSize = '0.9rem';
                switchButton.style.padding = '8px 16px';
                switchButton.addEventListener('click', () => switchToPlayer(i));
                
                const playerActions = document.createElement('div');
                playerActions.className = 'player-actions';
                playerActions.appendChild(switchButton);
                
                playerCard.appendChild(playerName);
                playerCard.appendChild(playerScore);
                playerCard.appendChild(playerCardsCount);
                playerCard.appendChild(playerActions);
                playersContainer.appendChild(playerCard);
            }
            
            // Create and shuffle deck
            createDeck();
            shuffleDeck();
            
            // Initialize player decks
            initializePlayerDecks();
            
            // Update UI
            updatePlayerTurn();
            updateDeckInfo();
            clearGameLog();
            addToLog(`Game started with ${playerCount} players.`);
            addToLog(`Deal cards to begin the battle!`);
            
            // Reset buttons
            dealBtn.disabled = false;
            battleBtn.disabled = true;
        }
        
        // Switch to a specific player for equation building
        function switchToPlayer(playerIndex) {
            if (!roundActive || battleCompleted) return;
            
            currentPlayerIndex = playerIndex;
            displayPlayerCards(playerIndex);
            updatePlayerTurn();
            updateCardSelectionInfo();
            
            // Highlight the current player
            document.querySelectorAll('.player-card').forEach((card, index) => {
                if (index === playerIndex) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
            
            addToLog(`${players[playerIndex].name} is now building their equation.`);
        }
        
        // Create a deck of cards based on settings
        function createDeck() {
            deck = [];
            const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
            let values = ['A', '2', '3', '4', '5', '6', '7', '8', '9'];
            const faceCardsSetting = faceCardsSelect.value;
            const aceValue = parseInt(aceValueSelect.value);
            
            // Add 10s and face cards if included
            if (faceCardsSetting === 'include') {
                values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            }
            
            // Add number cards
            for (let suit of suits) {
                for (let value of values) {
                    let numericValue;
                    
                    if (value === 'A') {
                        numericValue = aceValue;
                    } else if (value === 'J') {
                        numericValue = 11;
                    } else if (value === 'Q') {
                        numericValue = 12;
                    } else if (value === 'K') {
                        numericValue = 13;
                    } else {
                        numericValue = parseInt(value);
                    }
                    
                    deck.push({
                        suit: suit,
                        value: value,
                        numericValue: numericValue,
                        isWild: false
                    });
                }
            }
        }
        
        // Shuffle the deck using Fisher-Yates algorithm
        function shuffleDeck() {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }
        
        // Initialize player decks by splitting the deck
        function initializePlayerDecks() {
            const playerCount = parseInt(playerCountSelect.value);
            playerDecks = [];
            
            // Calculate cards per player (roughly equal)
            const cardsPerPlayer = Math.floor(deck.length / playerCount);
            
            for (let i = 0; i < playerCount; i++) {
                const playerDeck = [];
                const startIndex = i * cardsPerPlayer;
                const endIndex = (i === playerCount - 1) ? deck.length : (i + 1) * cardsPerPlayer;
                
                for (let j = startIndex; j < endIndex; j++) {
                    playerDeck.push(deck[j]);
                }
                
                playerDecks.push(playerDeck);
                players[i].cards = playerDeck.length;
            }
            
            updatePlayerCardCounts();
        }
        
        // Deal cards to players
        function dealCards() {
            if (!gameActive || roundActive) return;
            
            const cardsPerPlayer = parseInt(cardsPerPlayerSelect.value);
            const playerCount = parseInt(playerCountSelect.value);
            
            // Check if players have enough cards
            for (let i = 0; i < playerCount; i++) {
                if (playerDecks[i].length < cardsPerPlayer) {
                    addToLog(`Player ${i+1} doesn't have enough cards! Game over.`);
                    endGame();
                    return;
                }
            }
            
            // Deal cards to each player
            playerHands = [];
            for (let i = 0; i < playerCount; i++) {
                const hand = [];
                for (let j = 0; j < cardsPerPlayer; j++) {
                    if (playerDecks[i].length > 0) {
                        hand.push(playerDecks[i].pop());
                    }
                }
                playerHands.push(hand);
                players[i].cards = playerDecks[i].length;
            }
            
            // Initialize equations
            playerEquations = [];
            for (let i = 0; i < playerCount; i++) {
                playerEquations.push({ minuend: [], subtrahend: [] });
                players[i].equationComplete = false;
            }
            
            // Display first player's cards
            currentPlayerIndex = 0;
            displayPlayerCards(currentPlayerIndex);
            
            addToLog(`Cards dealt! Each player has ${cardsPerPlayer} cards.`);
            addToLog(`${players[currentPlayerIndex].name}, arrange your cards to create the greatest difference!`);
            addToLog(`Use the "Build Equation" buttons to switch between players.`);
            
            // Enable equation builder
            dealBtn.disabled = true;
            battleBtn.disabled = true;
            createEquationSlots();
            roundActive = true;
            
            updateDeckInfo();
            updatePlayerCardCounts();
            updateCardSelectionInfo();
            updatePlayerTurn();
        }
        
        // Display cards for a specific player
        function displayPlayerCards(playerIndex) {
            cardsContainer.innerHTML = '';
            selectedCard = null;
            
            const hand = playerHands[playerIndex];
            if (!hand) return;
            
            hand.forEach((card, index) => {
                const cardElement = createCardElement(card, index, playerIndex);
                cardsContainer.appendChild(cardElement);
            });
        }
        
        // Create a visual card element
        function createCardElement(card, index, playerIndex) {
            const cardElement = document.createElement('div');
            const isRed = card.suit === 'hearts' || card.suit === 'diamonds';
            cardElement.className = `card ${isRed ? 'red' : 'black'} ${card.isWild ? 'wild' : ''}`;
            cardElement.dataset.index = index;
            cardElement.dataset.player = playerIndex;
            
            const suitSymbol = getSuitSymbol(card.suit);
            
            cardElement.innerHTML = `
                <div class="card-suit">${suitSymbol}</div>
                <div class="card-value">${card.value}</div>
                <div class="card-suit bottom">${suitSymbol}</div>
            `;
            
            // Check if card is already used in equation
            if (isCardUsed(playerIndex, card)) {
                cardElement.classList.add('in-equation');
            }
            
            // Add click event for card selection
            cardElement.addEventListener('click', function() {
                if (!roundActive || battleCompleted) return;
                if (parseInt(this.dataset.player) !== currentPlayerIndex) return;
                
                // Deselect previously selected card
                if (selectedCard !== null) {
                    const prevCard = document.querySelector(`.card[data-index="${selectedCard}"][data-player="${currentPlayerIndex}"]`);
                    if (prevCard) prevCard.classList.remove('selected');
                }
                
                // Select this card
                this.classList.add('selected');
                selectedCard = index;
                
                updateCardSelectionInfo();
            });
            
            return cardElement;
        }
        
        // Get Unicode symbol for card suit
        function getSuitSymbol(suit) {
            switch(suit) {
                case 'hearts': return '‚ô•';
                case 'diamonds': return '‚ô¶';
                case 'clubs': return '‚ô£';
                case 'spades': return '‚ô†';
                default: return '';
            }
        }
        
        // Create equation slots for all players
        function createEquationSlots() {
            const digitCount = parseInt(digitCountSelect.value);
            const playerCount = parseInt(playerCountSelect.value);
            
            // Clear existing slots
            player1MinuendSlots.innerHTML = '';
            player1SubtrahendSlots.innerHTML = '';
            player2MinuendSlots.innerHTML = '';
            player2SubtrahendSlots.innerHTML = '';
            
            // Create slots for each player
            for (let playerIndex = 0; playerIndex < playerCount; playerIndex++) {
                const minuendSlots = document.getElementById(`player${playerIndex+1}MinuendSlots`);
                const subtrahendSlots = document.getElementById(`player${playerIndex+1}SubtrahendSlots`);
                
                // Create minuend slots
                for (let i = 0; i < digitCount; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'number-slot';
                    slot.dataset.position = i;
                    slot.dataset.type = 'minuend';
                    slot.dataset.player = playerIndex;
                    
                    slot.addEventListener('click', function() {
                        if (selectedCard !== null && parseInt(this.dataset.player) === currentPlayerIndex) {
                            placeCardInSlot(playerIndex, 'minuend', i);
                        } else if (parseInt(this.dataset.player) === currentPlayerIndex) {
                            this.classList.add('highlight');
                            setTimeout(() => this.classList.remove('highlight'), 500);
                        }
                    });
                    
                    minuendSlots.appendChild(slot);
                }
                
                // Create subtrahend slots
                for (let i = 0; i < digitCount; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'number-slot';
                    slot.dataset.position = i;
                    slot.dataset.type = 'subtrahend';
                    slot.dataset.player = playerIndex;
                    
                    slot.addEventListener('click', function() {
                        if (selectedCard !== null && parseInt(this.dataset.player) === currentPlayerIndex) {
                            placeCardInSlot(playerIndex, 'subtrahend', i);
                        } else if (parseInt(this.dataset.player) === currentPlayerIndex) {
                            this.classList.add('highlight');
                            setTimeout(() => this.classList.remove('highlight'), 500);
                        }
                    });
                    
                    subtrahendSlots.appendChild(slot);
                }
            }
        }
        
        // Place a card in a slot
        function placeCardInSlot(playerIndex, type, position) {
            if (selectedCard === null || playerIndex !== currentPlayerIndex) return;
            
            const hand = playerHands[playerIndex];
            const card = hand[selectedCard];
            
            // Check if the card is already used
            if (isCardUsed(playerIndex, card)) {
                alert('This card is already used in your equation!');
                return;
            }
            
            // Place the card in the equation
            playerEquations[playerIndex][type][position] = card;
            
            // Update the slot display
            const slot = document.querySelector(`.number-slot[data-player="${playerIndex}"][data-type="${type}"][data-position="${position}"]`);
            slot.textContent = card.value;
            slot.classList.add('filled');
            
            // Deselect the card and mark it as used
            const cardElement = document.querySelector(`.card[data-index="${selectedCard}"][data-player="${playerIndex}"]`);
            cardElement.classList.remove('selected');
            cardElement.classList.add('in-equation');
            selectedCard = null;
            
            // Update the equation result
            updateEquationResult(playerIndex);
            
            // Check if this player's equation is complete
            checkPlayerEquationComplete(playerIndex);
            
            // Check if all players have complete equations
            checkAllEquationsComplete();
        }
        
        // Check if a card is already used in a player's equation
        function isCardUsed(playerIndex, card) {
            for (let type of ['minuend', 'subtrahend']) {
                for (let pos in playerEquations[playerIndex][type]) {
                    if (playerEquations[playerIndex][type][pos] === card) {
                        return true;
                    }
                }
            }
            return false;
        }
        
        // Update the equation result display for a player
        function updateEquationResult(playerIndex) {
            const digitCount = parseInt(digitCountSelect.value);
            const equation = playerEquations[playerIndex];
            
            // Check if both minuend and subtrahend are complete
            if (equation.minuend.length !== digitCount || equation.subtrahend.length !== digitCount) {
                document.getElementById(`player${playerIndex+1}Result`).textContent = '?';
                document.getElementById(`player${playerIndex+1}Difference`).textContent = '';
                return;
            }
            
            // Build numbers from cards
            let minuend = '';
            let subtrahend = '';
            
            for (let i = 0; i < digitCount; i++) {
                minuend += equation.minuend[i] ? equation.minuend[i].numericValue : '0';
                subtrahend += equation.subtrahend[i] ? equation.subtrahend[i].numericValue : '0';
            }
            
            const minuendNum = parseInt(minuend);
            const subtrahendNum = parseInt(subtrahend);
            
            // Validate that minuend is greater than subtrahend
            if (minuendNum <= subtrahendNum) {
                document.getElementById(`player${playerIndex+1}Result`).textContent = 'Invalid';
                document.getElementById(`player${playerIndex+1}Difference`).textContent = 'Minuend must be greater than subtrahend';
                players[playerIndex].equationComplete = false;
                return;
            }
            
            const difference = minuendNum - subtrahendNum;
            document.getElementById(`player${playerIndex+1}Result`).textContent = difference;
            document.getElementById(`player${playerIndex+1}Difference`).textContent = `Difference: ${difference}`;
        }
        
        // Check if a specific player's equation is complete
        function checkPlayerEquationComplete(playerIndex) {
            const digitCount = parseInt(digitCountSelect.value);
            const equation = playerEquations[playerIndex];
            
            const minuendComplete = Object.keys(equation.minuend).length === digitCount;
            const subtrahendComplete = Object.keys(equation.subtrahend).length === digitCount;
            
            if (minuendComplete && subtrahendComplete) {
                // Also check if the equation is valid
                let minuend = '';
                let subtrahend = '';
                for (let j = 0; j < digitCount; j++) {
                    minuend += equation.minuend[j].numericValue;
                    subtrahend += equation.subtrahend[j].numericValue;
                }
                
                if (parseInt(minuend) > parseInt(subtrahend)) {
                    players[playerIndex].equationComplete = true;
                    addToLog(`${players[playerIndex].name}'s equation is complete!`);
                } else {
                    players[playerIndex].equationComplete = false;
                }
            } else {
                players[playerIndex].equationComplete = false;
            }
        }
        
        // Check if all players have complete equations
        function checkAllEquationsComplete() {
            const playerCount = parseInt(playerCountSelect.value);
            
            let allComplete = true;
            for (let i = 0; i < playerCount; i++) {
                if (!players[i].equationComplete) {
                    allComplete = false;
                    break;
                }
            }
            
            battleBtn.disabled = !allComplete;
            
            if (allComplete) {
                addToLog(`All players have complete equations! Ready for battle!`);
            }
        }
        
        // Clear the current player's equation
        function clearEquation() {
            if (!roundActive) return;
            
            const playerIndex = currentPlayerIndex;
            playerEquations[playerIndex] = { minuend: [], subtrahend: [] };
            players[playerIndex].equationComplete = false;
            selectedCard = null;
            
            // Clear all card selections for current player
            document.querySelectorAll(`.card[data-player="${playerIndex}"]`).forEach(card => {
                card.classList.remove('selected', 'in-equation');
            });
            
            // Clear all slots for current player
            document.querySelectorAll(`.number-slot[data-player="${playerIndex}"]`).forEach(slot => {
                slot.textContent = '';
                slot.classList.remove('filled');
            });
            
            // Reset displays for current player
            document.getElementById(`player${playerIndex+1}Result`).textContent = '?';
            document.getElementById(`player${playerIndex+1}Difference`).textContent = '';
            
            // Re-display cards to reset visual state
            displayPlayerCards(playerIndex);
            
            battleBtn.disabled = true;
            
            addToLog(`${players[playerIndex].name} cleared their equation.`);
        }
        
        // Clear all equations
        function clearAllEquations() {
            const playerCount = parseInt(playerCountSelect.value);
            
            for (let i = 0; i < playerCount; i++) {
                document.getElementById(`player${i+1}Result`).textContent = '?';
                document.getElementById(`player${i+1}Difference`).textContent = '';
            }
        }
        
        // Execute the battle
        function battle() {
            if (!roundActive || battleCompleted) return;
            
            const playerCount = parseInt(playerCountSelect.value);
            const digitCount = parseInt(digitCountSelect.value);
            
            // Calculate differences for all players
            const differences = [];
            for (let i = 0; i < playerCount; i++) {
                const equation = playerEquations[i];
                
                let minuend = '';
                let subtrahend = '';
                for (let j = 0; j < digitCount; j++) {
                    minuend += equation.minuend[j].numericValue;
                    subtrahend += equation.subtrahend[j].numericValue;
                }
                
                const minuendNum = parseInt(minuend);
                const subtrahendNum = parseInt(subtrahend);
                const difference = minuendNum - subtrahendNum;
                
                differences.push({
                    playerIndex: i,
                    difference: difference,
                    equation: `${minuendNum} - ${subtrahendNum} = ${difference}`
                });
                
                // Update display with final difference
                document.getElementById(`player${i+1}Difference`).textContent = `Difference: ${difference}`;
                document.getElementById(`player${i+1}Difference`).className = 'difference-display';
            }
            
            // Find the winner (largest difference)
            let winner = differences[0];
            let isTie = false;
            
            for (let i = 1; i < differences.length; i++) {
                if (differences[i].difference > winner.difference) {
                    winner = differences[i];
                    isTie = false;
                } else if (differences[i].difference === winner.difference) {
                    isTie = true;
                }
            }
            
            // Determine battle result
            let resultText = '';
            if (isTie) {
                resultText = "It's a tie! All players keep their cards.";
                addToLog(`Battle resulted in a tie! All differences were ${winner.difference}.`);
                
                // Return cards to each player's deck
                for (let i = 0; i < playerCount; i++) {
                    playerDecks[i] = playerDecks[i].concat(playerHands[i]);
                    players[i].cards = playerDecks[i].length;
                }
            } else {
                resultText = `${players[winner.playerIndex].name} wins with a difference of ${winner.difference}!`;
                addToLog(`${players[winner.playerIndex].name} wins the battle with ${winner.equation}`);
                
                // Winner takes all cards
                const allCards = [];
                for (let i = 0; i < playerCount; i++) {
                    allCards.push(...playerHands[i]);
                }
                
                playerDecks[winner.playerIndex] = playerDecks[winner.playerIndex].concat(allCards);
                players[winner.playerIndex].cards = playerDecks[winner.playerIndex].length;
                players[winner.playerIndex].wins++;
                
                // Update other players' card counts
                for (let i = 0; i < playerCount; i++) {
                    if (i !== winner.playerIndex) {
                        players[i].cards = playerDecks[i].length;
                    }
                }
                
                // Highlight winner's difference
                document.getElementById(`player${winner.playerIndex+1}Difference`).classList.add('winner');
            }
            
            battleResult.textContent = resultText;
            battleResult.style.display = 'block';
            
            // Update UI
            updatePlayerCardCounts();
            battleCompleted = true;
            roundActive = false;
            
            // Check for game winner
            checkForWinner();
            
            // Show next round button
            nextRoundBtn.style.display = 'inline-block';
            battleBtn.disabled = true;
        }
        
        // Move to next round
        function nextRound() {
            battleCompleted = false;
            nextRoundBtn.style.display = 'none';
            battleResult.style.display = 'none';
            
            // Reset to first player
            currentPlayerIndex = 0;
            
            // Enable dealing cards
            dealBtn.disabled = false;
            clearAllEquations();
            
            // Reset equation displays
            const playerCount = parseInt(playerCountSelect.value);
            for (let i = 0; i < playerCount; i++) {
                document.getElementById(`player${i+1}Difference`).className = 'difference-display';
            }
            
            // Update UI
            updatePlayerTurn();
            
            addToLog(`Starting new round. Deal cards to begin!`);
        }
        
        // Check if any player has won the game
        function checkForWinner() {
            const playerCount = parseInt(playerCountSelect.value);
            let winner = null;
            
            // Check if any player has all the cards
            for (let i = 0; i < playerCount; i++) {
                let totalCards = 0;
                for (let j = 0; j < playerCount; j++) {
                    totalCards += players[j].cards;
                }
                
                if (players[i].cards === totalCards) {
                    winner = players[i];
                    break;
                }
            }
            
            // Also check if any player has no cards left
            if (!winner) {
                for (let i = 0; i < playerCount; i++) {
                    if (players[i].cards === 0) {
                        // Find player with most cards
                        let mostCards = 0;
                        for (let j = 0; j < playerCount; j++) {
                            if (players[j].cards > mostCards) {
                                mostCards = players[j].cards;
                                winner = players[j];
                            }
                        }
                        break;
                    }
                }
            }
            
            if (winner) {
                gameActive = false;
                roundActive = false;
                
                winMessage.textContent = `üéâ ${winner.name} wins the game with ${winner.cards} cards and ${winner.wins} battle wins! üéâ`;
                winMessage.style.display = 'block';
                addToLog(`üéâ ${winner.name} wins the game! üéâ`);
                
                // Highlight winning player
                document.getElementById(`playerCard${winner.id}`).classList.add('winner');
                document.getElementById(`playerScore${winner.id}`).classList.add('winner');
            }
        }
        
        // Update player turn display
        function updatePlayerTurn() {
            if (roundActive && !battleCompleted) {
                playerTurn.textContent = `${players[currentPlayerIndex].name}'s Turn - Arrange your cards for the greatest difference!`;
                
                // Highlight current player's card
                document.querySelectorAll('.player-card').forEach((card, index) => {
                    if (index === currentPlayerIndex) {
                        card.classList.add('active');
                    } else {
                        card.classList.remove('active');
                    }
                });
            } else {
                playerTurn.textContent = battleCompleted ? 
                    "Battle complete! Ready for next round?" : 
                    "Deal cards to begin the battle!";
                
                // Remove active highlights
                document.querySelectorAll('.player-card').forEach(card => {
                    card.classList.remove('active');
                });
            }
        }
        
        // Update deck information
        function updateDeckInfo() {
            const cardsPerPlayer = parseInt(cardsPerPlayerSelect.value);
            const playerCount = parseInt(playerCountSelect.value);
            deckInfo.textContent = `Cards in play: ${cardsPerPlayer * playerCount}`;
        }
        
        // Update player card counts
        function updatePlayerCardCounts() {
            players.forEach(player => {
                document.getElementById(`playerScore${player.id}`).textContent = `${player.cards} Cards`;
                document.getElementById(`playerCardsCount${player.id}`).textContent = `Wins: ${player.wins}`;
            });
        }
        
        // Update card selection info text
        function updateCardSelectionInfo() {
            if (selectedCard !== null) {
                cardSelectionInfo.textContent = 'Card selected. Click on a slot to place it in your equation.';
            } else {
                cardSelectionInfo.textContent = `Select a card, then click where you want to place it in ${players[currentPlayerIndex].name}'s subtraction problem.`;
            }
        }
        
        // Game log functions
        function addToLog(message) {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = message;
            gameLog.appendChild(logEntry);
            gameLog.scrollTop = gameLog.scrollHeight;
        }
        
        function clearGameLog() {
            gameLog.innerHTML = '';
        }
        
        // Event listeners
        dealBtn.addEventListener('click', dealCards);
        battleBtn.addEventListener('click', battle);
        clearEquationBtn.addEventListener('click', clearEquation);
        nextRoundBtn.addEventListener('click', nextRound);
        resetGameBtn.addEventListener('click', initializeGame);
        applySettingsBtn.addEventListener('click', initializeGame);
        
        // Initialize the game on load
        initializeGame();
    });
</script>
